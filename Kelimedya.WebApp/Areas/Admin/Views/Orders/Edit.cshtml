@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Kelimedya.Core.Enum
@using Kelimedya.Core.Models     <!-- USERS/PRODUCTS tip isimleri -->
@using System.Text.Json
@using Kelimedya.WebApp.Areas.Admin.Models
@model Kelimedya.WebApp.Areas.Admin.Models.OrderViewModel

@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Sipariş Düzenle";
}

<div class="page-header d-print-none">
    <div class="container-xl">
        <h2 class="page-title">Sipariş Düzenle</h2>
        <div class="text-muted mt-1">
            Sipariş bilgilerini güncelleyin.
        </div>
    </div>
</div>

<div class="page-body pt-2">
    <div class="container-xl">
        @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.SelectMany(v => v.Errors).Any())
        {
            <div class="alert alert-danger" role="alert">
                @Html.ValidationSummary(false, "", new { @class = "mb-0" })
            </div>
        }
        <div class="card">
            <div class="card-body">
                <form method="post" asp-action="Edit">
                    <input type="hidden" asp-for="Id"/>

                    <div class="mb-3">
                        <label class="form-label">Kullanıcı</label>
                        <select class="form-select" asp-for="UserId"
                                asp-items="@(new SelectList((IEnumerable<UserDto>)(ViewBag.Users ?? new List<UserDto>()), "Id", "UserName", Model?.UserId))">
                            <option value="">Seçiniz</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Sipariş Numarası</label>
                        <input type="text" class="form-control" asp-for="OrderNumber" readonly />
                        <span asp-validation-for="OrderNumber" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Müşteri Adı</label>
                        <input type="text" class="form-control" asp-for="CustomerName"/>
                        <span asp-validation-for="CustomerName" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Müşteri Email</label>
                        <input type="email" class="form-control" asp-for="CustomerEmail" readonly />
                        <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Sipariş Tarihi</label>
                        <input type="date" class="form-control" asp-for="OrderDate"/>
                        <span asp-validation-for="OrderDate" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ürün</label>
                        <select class="form-select" asp-for="ProductId"
                                asp-items="@(new SelectList((IEnumerable<ProductViewModel>)(ViewBag.Products ?? new List<ProductViewModel>()), "Id", "Name", Model?.ProductId))">
                            <option value="">Seçiniz</option>
                        </select>
                        <span asp-validation-for="ProductId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Kupon Kodu</label>
                        <input class="form-control" asp-for="CouponCode" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">İndirim Tutarı</label>
                        <input type="number" step="0.01" class="form-control" asp-for="DiscountAmount" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ara Toplam</label>
                        <input type="number" step="0.01" class="form-control" asp-for="SubTotal" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Toplam Tutar</label>
                        <input type="number" step="0.01" class="form-control" asp-for="TotalAmount"/>
                        <span asp-validation-for="TotalAmount" class="text-danger"></span>
                    </div>

                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" asp-for="IsActive" type="checkbox" />
                        <label class="form-check-label" for="IsActive">Aktif</label>
                    </div>
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" asp-for="IsDeleted" type="checkbox" />
                        <label class="form-check-label" for="IsDeleted">Silindi</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Sipariş Durumu</label>
                        <select class="form-select" asp-for="Status">
                            @foreach (var status in Enum.GetValues(typeof(OrderStatus)))
                            {
                                <option value="@status">@status</option>
                            }
                        </select>
                        <span asp-validation-for="Status" class="text-danger"></span>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Güncelle</button>
                        <a asp-action="Index" class="btn btn-link link-secondary">Vazgeç</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // DİKKAT: PascalCase alan adları
        const users = @Html.Raw(JsonSerializer.Serialize(ViewBag.Users ?? new List<UserDto>()));
        const products = @Html.Raw(JsonSerializer.Serialize(ViewBag.Products ?? new List<ProductViewModel>()));

        const userSelect = document.getElementById('UserId');
        const productSelect = document.getElementById('ProductId');
        const customerNameInput = document.getElementById('CustomerName');
        const customerEmailInput = document.getElementById('CustomerEmail');
        const subTotalInput = document.getElementById('SubTotal');
        const totalAmountInput = document.getElementById('TotalAmount');

        userSelect?.addEventListener('change', function () {
            const selVal = this.value; // string
            const user = users.find(u => String(u.Id) === selVal);
            customerNameInput.value = user ? (user.FullName || user.UserName || '') : '';
            customerEmailInput.value = user ? (user.Email || '') : '';
        });

        productSelect?.addEventListener('change', function () {
            const selVal = parseInt(this.value);
            const product = products.find(p => p.Id === selVal);
            const price = product ? product.Price : '';
            subTotalInput.value = price;
            totalAmountInput.value = price;
        });

        // Sayfa yüklenince mevcut Model değerlerine göre alanları doldur
        userSelect?.dispatchEvent(new Event('change'));
        productSelect?.dispatchEvent(new Event('change'));
    </script>
}
